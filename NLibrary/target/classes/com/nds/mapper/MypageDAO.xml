<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nds.library.mypage.IMypageDAO">
	<select id="mypageBorrow" parameterType="java.util.Map"
	resultType="com.nds.library.mypage.Borrowing">
		select * from (borrowings join books using(book_id)) join informations using(information_id)
		where user_id = #{user_id}
	</select>
	
	<select id="mypageReserveList" parameterType="java.util.Map"
	resultType="com.nds.library.mypage.Borrowing">
		select *
		from ((books join informations using(information_id)) join reservations using(book_id)) join users using(user_id)
   		 where current_state = '예약' and user_id = #{user_id}
	</select>

	<select id="totalCount" resultType="java.lang.Integer"
		parameterType="java.util.Map">
		select count(*) from reqanddon

		<if test="kind == 'require'">
			<if test="filter == 0">  <!-- 전체 -->
				where (current_state='신청대기'
				or current_state='신청완료' or
				current_state='구매완료' or current_state='신청반려')
			</if>
			<if test="filter == 1">  <!-- 구매완료 -->
				where current_state='구매완료'
			</if>
			<if test="filter == 2">  <!-- 신청완료 -->
				where current_state='신청완료'
			</if>
			<if test="filter == 3"> <!-- 신청대기 -->
				where current_state='신청대기'
			</if>
			<if test="filter == 4">  <!-- 신청반려 -->
				where current_state='신청반려'
			</if>
		</if>
		<if test="kind == 'donation'">
			<if test="filter == 0">  <!-- 전체 -->
				where (current_state='기증대기'
				or current_state='기증완료' or
				current_state='기증반려')
			</if>
			<if test="filter == 1"> <!-- 기증대기 -->
				where current_state='기증대기'
			</if>
			<if test="filter == 2">  <!-- 기증완료 -->
				where current_state='기증완료'
			</if>

			<if test="filter == 3">  <!-- 기증반려 -->
				where current_state='기증반려'
			</if>
		</if>
		and user_id=#{sessionId} order by reqanddon.registered_date desc
	</select>

	<select id="requireBookList" parameterType="java.util.Map"
		resultType="com.nds.library.mypage.ReqAndDon">

		select b.* from
		(select rownum as rnum, a.* from
		(select REQ_DON_ID,
		image, title, author, publisher, TO_CHAR(registered_date,
		'yyyy-mm-dd') AS registered_date,
		current_state, TO_CHAR(finished_date,
		'yyyy-mm-dd') AS finished_date, manager_comment
		from reqanddon

		<if test="filter == 0">  <!-- 전체 -->
			where (current_state='신청대기'
			or current_state='신청완료' or
			current_state='구매완료' or current_state='신청반려')
		</if>
		<if test="filter == 1">  <!-- 구매완료 -->
			where current_state='구매완료'
		</if>
		<if test="filter == 2">  <!-- 신청완료 -->
			where current_state='신청완료'
		</if>
		<if test="filter == 3"> <!-- 신청대기 -->
			where current_state='신청대기'
		</if>
		<if test="filter == 4">  <!-- 신청반려 -->
			where current_state='신청반려'
		</if>
		<![CDATA[
		and user_id=#{sessionId} order by reqanddon.registered_date desc)a)b
		where rnum >=#{start} and rnum <= #{end}]]>
	</select>

	<insert id="requireBookAdd">

		INSERT INTO ReqAndDon(req_don_id,
		manager_id,
		user_id,
		current_state, registered_date, user_comment,
		manager_comment,
		finished_date
		, isbn, title, author, publisher, image,
		pubdate,
		explanation)
		VALUES((SELECT NVL(MAX(req_don_id)+1, 1) FROM
		ReqAndDon),
		1, #{user_id},
		'신청대기', sysdate, #{user_comment}, null, null,
		#{isbn},
		#{title},
		#{author},
		#{publisher},#{image},
		#{pubdate},
		#{explanation})
	</insert>


	<select id="donationBookList" parameterType="java.util.Map"
		resultType="com.nds.library.mypage.ReqAndDon">

		select b.* from
		(select rownum as rnum, a.* from
		(select REQ_DON_ID,
		image, title, author, publisher, TO_CHAR(registered_date,
		'yyyy-mm-dd') AS registered_date,
		current_state, TO_CHAR(finished_date,
		'yyyy-mm-dd') AS finished_date, manager_comment
		from reqanddon

		<if test="filter == 0">  <!-- 전체 -->
			where (current_state='기증대기'
			or current_state='기증완료' or
			current_state='기증반려')
		</if>
		<if test="filter == 1"> <!-- 기증대기 -->
			where current_state='기증대기'
		</if>
		<if test="filter == 2">  <!-- 기증완료 -->
			where current_state='기증완료'
		</if>
		<if test="filter == 3">  <!-- 기증반려 -->
			where current_state='기증반려'
		</if>
		<![CDATA[
		and user_id=#{sessionId} order by reqanddon.registered_date desc)a)b
		where rnum >=#{start} and rnum <= #{end}]]>
	</select>

	<insert id="donationBookAdd">

		INSERT INTO ReqAndDon(req_don_id,
		manager_id,
		user_id,
		current_state, registered_date, user_comment,
		manager_comment,
		finished_date
		, isbn, title, author, publisher, image,
		pubdate,
		explanation)
		VALUES((SELECT NVL(MAX(req_don_id)+1, 1) FROM
		ReqAndDon),
		1, #{user_id},
		'기증대기', sysdate, #{user_comment}, null, null,
		#{isbn},
		#{title},
		#{author},
		#{publisher},#{image},
		#{pubdate},
		#{explanation})
	</insert>
	
	<select id="getMessageList" parameterType="java.util.Map"
	resultType="com.nds.library.mypage.Message">
		SELECT * FROM messages WHERE user_id = #{user_id}
	</select>
	
	<select id="messageDetail" resultType="com.nds.library.mypage.Message">
		SELECT message_id,
		user_id, is_checked, title, content, sended_date, checked_date
		FROM
		messages
		WHERE message_id = #{msg_id}
	</select>
	
	<select id="findUserByUserId" resultType="com.nds.library.mypage.User">
		SELECT *
		FROM users
		WHERE user_id = #{user_id}
	</select>
</mapper>   

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nds.library.board.IBoardDAO">

	<select id="boardList" parameterType="java.util.HashMap"
		resultType="com.nds.library.board.Board">
		select board_id, user_id, category, title, content, 
		TO_CHAR(boarded_date,'yyyy-mm-dd') AS boarded_date,
		TO_CHAR(modified_date,'yyyy-mm-dd') AS modified_date,
		read_count, blind, name
		from
		(
		select rownum rn, aa.*
		from
		(select * from boards join
		users using(user_id)
		<if test="type == 'notice'">
      		<![CDATA[
			WHERE category = '공지' 
			order by board_id desc)aa)
			where rn between #{startNumber} and #{startNumber}+9
			]]>
		</if>
		<if test="type == 'study'">
      		<![CDATA[
			WHERE category = '스터디' 
			order by board_id desc)aa)
			where rn between #{startNumber} and #{startNumber}+9
			]]>
		</if>

	</select>

	<select id="reqaAndDonList" parameterType="java.util.HashMap"
		resultType="com.nds.library.board.ReqandDon">
		select *
		from
		(
		select rownum rn, aa.*
		from
		(select * from ReqandDon join
		users using(user_id)
		<if test="type == 'require'">
			WHERE current_state = '승인대기' or current_state = '신청완료'
			or
			current_state = '구매완료' or current_state = '신청반려'
			order by req_don_id
			desc)aa)
			where rn between #{startNumber} and #{startNumber}+9
		</if>
		<if test="type == 'donation'">
			WHERE current_state LIKE '기증%'
			order by req_don_id desc)aa)
			where rn between #{startNumber} and
			#{startNumber}+9
		</if>
	</select>

	<select id="detailBoard" parameterType="java.util.HashMap"
		resultType="com.nds.library.board.Board">
		SELECT board_id, user_id, category, title, content, 
		TO_CHAR(boarded_date,'yyyy-mm-dd') AS boarded_date,
		TO_CHAR(modified_date,'yyyy-mm-dd') AS modified_date,
		read_count, blind, name
		FROM boards join users using(user_id)
		WHERE board_id
		= #{board_id}
	</select>

	<update id="readCount" parameterType="java.util.HashMap">
		update boards
		set read_count
		= (select read_count from boards where
		board_id=#{board_id})+1
		where
		board_id=#{board_id}
	</update>

	<select id="replyCount" parameterType="java.util.HashMap"
		resultType="Integer">
		SELECT count(*)
		FROM replys
		<if test="type == 'board'">
			where board_id=#{board_id}
		</if>
		<if test="type == 'reqanddon'">
			where req_don_id=#{req_don_id}
		</if>

	</select>

	<select id="replyList" parameterType="java.util.HashMap"
		resultType="com.nds.library.board.Reply">
		SELECT *
		FROM replys join users using(user_id)
		<if test="type == 'board'">
			where board_id=#{board_id}
			ORDER BY reply_id desc
		</if>
		<if test="type == 'reqanddon'">
			where req_don_id=#{req_don_id}
			ORDER BY reply_id desc
		</if>
	</select>

	<insert id="addReply" parameterType="java.util.HashMap">
		Insert into REPLYS
		(REPLY_ID,USER_ID,BOARD_ID,CONTENT,REPLYED_DATE,BLIND, REQ_DON_ID)
		<if test="type == 'board'">
			values ((SELECT NVL(MAX(REPLY_ID), 0)+1 FROM REPLYS),
			#{user_id},
			#{board_id}, #{content}, sysdate, 0, null)
		</if>
		<if test="type == 'reqanddon'">
			values ((SELECT NVL(MAX(REPLY_ID), 0)+1 FROM REPLYS),
			#{user_id}, null,
			#{content}, sysdate, 0, #{req_don_id})
		</if>

	</insert>

	<delete id="deleteReply" parameterType="java.util.HashMap">
		Delete from replys where
		reply_id=#{reply_id}
	</delete>

	<insert id="addBoard">
		INSERT INTO boards (board_id, user_id, category,
		title, content)
		VALUES ((SELECT NVL(MAX(board_id)+1, 1) FROM boards),
		#{user_id} ,
		#{category} , #{title} , #{content} )
	</insert>

	<select id="Boardcount" parameterType="java.util.HashMap"
		resultType="Integer">
		SELECT count(*)
		FROM boards
		<if test="type == 'notice'">
			WHERE category = '공지'
		</if>
		<if test="type == 'study'">
			WHERE category = '스터디'
		</if>
	</select>

	<select id="reQandDonCount" parameterType="java.util.HashMap"
		resultType="Integer">
		SELECT count(*)
		FROM ReqandDon join users using(user_id)
		<if test="type == 'require'">
			WHERE current_state = '승인대기' or current_state = '신청완료'
			or
			current_state = '구매완료' or current_state = '신청반려'
		</if>
		<if test="type == 'donation'">
			WHERE current_state LIKE '기증%'
		</if>
	</select>

	<select id="detailReQandDon" parameterType="java.util.HashMap"
		resultType="com.nds.library.board.ReqandDon">
		SELECT *
		FROM ReqandDon join users using(user_id)
		WHERE
		req_don_id = #{req_don_id}
	</select>

	<select id="reqaAndDonFilterList" parameterType="java.util.HashMap"
		resultType="com.nds.library.board.ReqandDon">
		select *
		from
		(
		select rownum rn, aa.*
		from
		(select * from ReqandDon join
		users using(user_id)
		<if test="filter==1">
			WHERE current_state = '구매완료'
			order by req_don_id desc)aa)
			where rn between
			#{startNumber} and #{startNumber}+9
		</if>
		<if test="filter==2">
			WHERE current_state = '신청완료'
			order by req_don_id desc)aa)
			where rn between
			#{startNumber} and #{startNumber}+9
		</if>
		<if test="filter==3">
			WHERE current_state = '신청대기'
			order by req_don_id desc)aa)
			where rn between
			#{startNumber} and #{startNumber}+9
		</if>
		<if test="filter==4">
			WHERE current_state = '신청반려'
			order by req_don_id desc)aa)
			where rn between
			#{startNumber} and #{startNumber}+9
		</if>

		<if test="filter==5">
			WHERE current_state = '기증대기'
			order by req_don_id desc)aa)
			where rn between 
			#{startNumber} and #{startNumber}+9
		</if>
		<if test="filter==6">
			WHERE current_state = '기증완료'
			order by req_don_id desc)aa)
			where rn between 
			#{startNumber} and #{startNumber}+9
		</if>
		<if test="filter==7">
			WHERE current_state = '기증반려'
			order by req_don_id desc)aa)
			where rn between 
			#{startNumber} and #{startNumber}+9
		</if>
		
	</select>

	<select id="reqaAndDonFilterCount" parameterType="java.util.HashMap"
		resultType="Integer">
		SELECT count(*)
		FROM ReqandDon join users using(user_id)
		<if test="filter==1">
			WHERE current_state = '구매완료'
		</if>
		<if test="filter==2">
			WHERE current_state = '신청완료'
		</if>
		<if test="filter==3">
			WHERE current_state = '신청대기'
		</if>
		<if test="filter==4">
			WHERE current_state = '신청반려'
		</if>
		<if test="filter==5">
			WHERE current_state = '기증대기'
		</if>
		<if test="filter==6">
			WHERE current_state = '기증완료'
		</if>
		<if test="filter==7">
			WHERE current_state = '기증반려'
		</if>
	</select>

</mapper>   